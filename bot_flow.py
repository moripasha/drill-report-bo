Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ Ú¯Ø±ÙØªÛŒ Ø§Ø´Ú©Ø§Ù„ Ø±ÙˆØŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÙˆÙ† Ø¯Ùˆ Ø¬Ø§ Ú¯ÛŒØ±Ù‡ ğŸ‘Œ
Ø¨ÛŒØ§ Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ùˆ Ø¯Ø±Ø³Øª Ú©Ù†ÛŒÙ…:

1. Ø¨Ø¹Ø¯ Ø§Ø² Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ:
Ø§Ù„Ø§Ù† ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Â«Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨Â» Ø±Ùˆ Ø¨Ø²Ù†ÛŒ Ù…ÛŒâ€ŒØ±Ù‡ Ø³Ø±Ø§Øº Ø¢Ø¨ Ù…ØµØ±ÙÛŒ. ØªÙˆ Ø§Ú¯Ø± ÙÙ‚Ø· Ú¯Ù„â€ŒÙ‡Ø§ Ø±Ùˆ Ø¨Ø²Ù†ÛŒ Ùˆ Ù‡ÛŒÚ†ÛŒ Ø±Ùˆ Ù†Ø²Ù†ÛŒØŒ Ø·Ø¨ÛŒØ¹ÛŒÙ‡ Ø§ØªÙØ§Ù‚ÛŒ Ù†Ù…ÛŒÙØªÙ‡. Ù…Ù† ØªÙˆ Ù…ØªÙ† Ùˆ Ù…Ù†Ø·Ù‚ØŒ Ø§ÛŒÙ† Ø±Ùˆ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ú©Ø±Ø¯Ù… Ú©Ù‡:

Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ÛŒØ¯ Â«Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨Â» Ø±Ùˆ Ø¨Ø²Ù†ÛŒ

Ù‡Ø± Ú¯Ù„ Ø±Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø²Ù†ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´Ù‡ (ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§)



2. Ø¨Ø¹Ø¯ Ù…ØªØ±Ø§Ú˜ (Ø·ÙˆÙ„ Ø´ÛŒÙØª):
Ø¯ÛŒÚ¯Ù‡ Ø§ÙˆÙ† Â«Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù‡Ø±Ú†ÛŒØ²ÛŒ Ø¨ÙØ±Ø³ØªÛŒØ¯Â» Ø±Ùˆ Ø­Ø°Ù Ú©Ø±Ø¯Ù….
Ø§Ù„Ø§Ù† Ø¨Ù‡â€ŒÙ…Ø­Ø¶ Ø§ÛŒÙ†â€ŒÚ©Ù‡ Ù…ØªØ±Ø§Ú˜ Ù¾Ø§ÛŒØ§Ù† Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ:

Ø®ÙˆØ¯Ø´ Ø·ÙˆÙ„ Ø´ÛŒÙØª Ø±Ùˆ Ø­Ø³Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ù‡

Ù‡Ù…ÙˆÙ†â€ŒØ¬Ø§ Ù†ØªÛŒØ¬Ù‡ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ù…ÛŒâ€ŒØ¯Ù‡

Ù‡Ù…â€ŒØ²Ù…Ø§Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ² Ø­ÙØ§Ø±ÛŒ (BQ/NQ/HQ/PQ) Ù…ÛŒØ§Ø¯ Ù¾Ø§ÛŒÛŒÙ†Ø´ â†’ ÛŒØ¹Ù†ÛŒ Ø¯Ú©Ù…Ù‡ØŒ Ù†Ù‡ ØªØ§ÛŒÙ¾.




Ø§ÛŒÙ† ÛŒØ¹Ù†ÛŒ Ù‡Ù… UX Ø¨Ù‡ØªØ±ØŒ Ù‡Ù… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ù…Ø·Ø§Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡ ØªÙˆ.

Ù‡Ù…ÛŒØ´Ù‡ Ø·Ø¨Ù‚ Ù‚Ø§Ù†ÙˆÙ†ØŒ Ú©Ù„ ÙØ§ÛŒÙ„ bot_flow.py Ø±Ùˆ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ¯Ù… ğŸ‘‡
Ø¨Ø±Ùˆ ØªÙˆ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ â†’ bot_flow.py â†’ Edit â†’ Ù‡Ù…Ù‡â€ŒØ§Ø´ Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù† â†’ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø§ÛŒÙ†Ùˆ Ø¨Ú†Ø³Ø¨ÙˆÙ†:


---

bot_flow.py (Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø§ØµÙ„Ø§Ø­ Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ Ùˆ Ù…ØªØ±Ø§Ú˜)

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
)
from telegram.ext import ContextTypes

# ================================
#  Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒÙ‡Ø§
# ================================

user_states = {}
user_data = {}

# Ù…Ø±Ø§Ø­Ù„ Ù‡Ø¯Ø±
STEP_REGION = "region"
STEP_BOREHOLE = "borehole"
STEP_RIG = "rig"
STEP_ANGLE = "angle"
STEP_DATE_YEAR = "date_year"
STEP_DATE_MONTH = "date_month"
STEP_DATE_DAY = "date_day"

# Ù…Ø±Ø§Ø­Ù„ Ø´ÛŒÙØªâ€ŒÙ‡Ø§
STEP_CHOOSE_SHIFT = "choose_shift"
STEP_START_DEPTH = "start_depth"
STEP_END_DEPTH = "end_depth"
STEP_SIZE = "size"
STEP_MUD = "mud"
STEP_WATER = "water"
STEP_DIESEL = "diesel"
STEP_ASK_NEXT_SHIFT = "ask_next_shift"

# ÙˆÙ‚ØªÛŒ Ø´ÛŒÙØªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯
STEP_SHIFTS_DONE = "shifts_done"


# ================================
#   Ø´Ø±ÙˆØ¹ ÙÙ„Ùˆ
# ================================

async def start_flow(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    user_states[user_id] = STEP_REGION
    user_data[user_id] = {
        "region": None,
        "borehole": None,
        "rig": None,
        "angle_deg": None,
        "date": None,

        "shifts": {
            "day": {},
            "night": {},
        },
        "current_shift": None
    }

    await update.message.reply_text("ğŸ”¸ Ù„Ø·ÙØ§Ù‹ *Ù…Ù†Ø·Ù‚Ù‡* Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
                                    parse_mode="Markdown")


# ================================
#   Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
# ================================

async def flow_router(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = (update.message.text or "").strip()

    if user_id not in user_states:
        await update.message.reply_text("Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ /start Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.")
        return

    step = user_states[user_id]

    # ----------------------------------
    #   Ù…Ø±Ø§Ø­Ù„ Ù‡Ø¯Ø±
    # ----------------------------------

    if step == STEP_REGION:
        user_data[user_id]["region"] = text
        user_states[user_id] = STEP_BOREHOLE
        await update.message.reply_text("ğŸ”¸ *Ø´Ù…Ø§Ø±Ù‡ Ú¯Ù…Ø§Ù†Ù‡* Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
                                        parse_mode="Markdown")
        return

    if step == STEP_BOREHOLE:
        user_data[user_id]["borehole"] = text
        user_states[user_id] = STEP_RIG

        buttons = [
            [InlineKeyboardButton("DB 1200", callback_data="rig_DB1200")],
            [InlineKeyboardButton("DBC-S15-A", callback_data="rig_DBC")],
        ]
        markup = InlineKeyboardMarkup(buttons)

        await update.message.reply_text("ğŸ”¸ *Ù†ÙˆØ¹ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø­ÙØ§Ø±ÛŒ* Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                                        reply_markup=markup,
                                        parse_mode="Markdown")
        return

    if step == STEP_ANGLE:
        try:
            angle_val = float(text.replace(",", "."))
        except ValueError:
            await update.message.reply_text("â›” Ù„Ø·ÙØ§Ù‹ Ø²Ø§ÙˆÛŒÙ‡ Ø±Ø§ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
            return

        user_data[user_id]["angle_deg"] = angle_val
        user_states[user_id] = STEP_DATE_YEAR

        await update.message.reply_text("ğŸ”¸ Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return

    if step == STEP_DATE_YEAR:
        if not text.isdigit():
            await update.message.reply_text("â›” Ø³Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯.")
            return

        year = int(text)
        if year < 1300 or year > 1500:
            await update.message.reply_text("â›” Ø³Ø§Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.")
            return

        user_data[user_id]["date_year"] = year
        user_states[user_id] = STEP_DATE_MONTH
        await update.message.reply_text("ğŸ”¸ Ù…Ø§Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Û± ØªØ§ Û±Û²):")
        return

    if step == STEP_DATE_MONTH:
        if not text.isdigit():
            await update.message.reply_text("â›” Ù…Ø§Ù‡ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯.")
            return

        month = int(text)
        if not 1 <= month <= 12:
            await update.message.reply_text("â›” Ù…Ø§Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û± ØªØ§ Û±Û² Ø¨Ø§Ø´Ø¯.")
            return

        user_data[user_id]["date_month"] = month
        user_states[user_id] = STEP_DATE_DAY
        await update.message.reply_text("ğŸ”¸ Ø±ÙˆØ² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Û± ØªØ§ Û³Û±):")
        return

    if step == STEP_DATE_DAY:
        if not text.isdigit():
            await update.message.reply_text("â›” Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯.")
            return

        day = int(text)
        if not 1 <= day <= 31:
            await update.message.reply_text("â›” Ø±ÙˆØ² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û± ØªØ§ Û³Û± Ø¨Ø§Ø´Ø¯.")
            return

        year = user_data[user_id]["date_year"]
        month = user_data[user_id]["date_month"]

        date_str = f"{day:02d}/{month:02d}/{year}"
        user_data[user_id]["date"] = date_str

        del user_data[user_id]["date_year"]
        del user_data[user_id]["date_month"]

        # Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø¯Ø± â†’ Ø´ÛŒÙØªâ€ŒÙ‡Ø§
        await show_header_summary(update, user_id)
        await ask_shift_choice(update, user_id)
        return

    # ----------------------------------
    #   Ù…Ø±Ø§Ø­Ù„ Ø´ÛŒÙØªâ€ŒÙ‡Ø§
    # ----------------------------------

    if step == STEP_START_DEPTH:
        return await handle_start_depth(update, user_id, text)

    if step == STEP_END_DEPTH:
        return await handle_end_depth(update, user_id, text)

    if step == STEP_WATER:
        return await handle_water(update, user_id, text)

    if step == STEP_DIESEL:
        return await handle_diesel(update, user_id, text)

    # Ø§Ú¯Ø± Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… Ù†Ø¨ÙˆØ¯
    await update.message.reply_text("â›” Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.")


# ================================
#   Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ (Callback)
# ================================

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    data = query.data

    if user_id not in user_states:
        await query.edit_message_text("Ø¬Ù„Ø³Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ â†’ /start")
        return

    # Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø­ÙØ§Ø±ÛŒ
    if data.startswith("rig_"):
        rig_label = "DB 1200" if data == "rig_DB1200" else "DBC-S15-A"
        user_data[user_id]["rig"] = rig_label
        user_states[user_id] = STEP_ANGLE

        await query.edit_message_text("ğŸ”¸ Ø²Ø§ÙˆÛŒÙ‡ Ø­ÙØ§Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return

    # Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÛŒÙØª
    if data in ("shift_day", "shift_night"):
        shift_key = "day" if data == "shift_day" else "night"
        user_data[user_id]["current_shift"] = shift_key
        return await ask_start_depth(query, user_id)

    # Ø³Ø§ÛŒØ² Ø­ÙØ§Ø±ÛŒ
    if data.startswith("size_"):
        size = data.replace("size_", "")
        return await set_size(query, user_id, size)

    # Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ
    if data.startswith("mud_"):
        return await toggle_mud(query, user_id, data.replace("mud_", ""))

    # ØªØ§ÛŒÛŒØ¯ Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ
    if data == "mud_done":
        return await ask_water(query, user_id)

    # Ø¢ÛŒØ§ Ø´ÛŒÙØª Ø¯ÙˆÙ… Ù‡Ù… Ø¨Ú¯ÛŒØ±Ø¯ØŸ
    if data == "need_night":
        return await ask_shift_choice(query, user_id, only_night=True)

    if data == "no_more_shift":
        return await finish_shifts(query, user_id)


# ============================================================
#       Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡ Ù‡Ø¯Ø±
# ============================================================

async def show_header_summary(update_or_query, user_id):
    d = user_data[user_id]
    msg = (
        "âœ… Ù‡Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯:\n"
        f"â€¢ Ù…Ù†Ø·Ù‚Ù‡: {d['region']}\n"
        f"â€¢ Ø´Ù…Ø§Ø±Ù‡ Ú¯Ù…Ø§Ù†Ù‡: {d['borehole']}\n"
        f"â€¢ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø­ÙØ§Ø±ÛŒ: {d['rig']}\n"
        f"â€¢ Ø²Ø§ÙˆÛŒÙ‡: {d['angle_deg']} Ø¯Ø±Ø¬Ù‡\n"
        f"â€¢ ØªØ§Ø±ÛŒØ®: {d['date']}\n\n"
        "Ø­Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ø¨Ø®Ø´ Ø´ÛŒÙØªâ€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…."
    )

    try:
        await update_or_query.message.reply_text(msg)
    except:
        await update_or_query.edit_message_text(msg)


# ============================================================
#       Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÛŒÙØª
# ============================================================

async def ask_shift_choice(update_or_query, user_id, only_night=False):
    user_states[user_id] = STEP_CHOOSE_SHIFT

    if only_night:
        buttons = [
            [InlineKeyboardButton("Ø´ÛŒÙØª Ø´Ø¨", callback_data="shift_night")]
        ]
    else:
        buttons = [
            [InlineKeyboardButton("Ø´ÛŒÙØª Ø±ÙˆØ²", callback_data="shift_day")],
            [InlineKeyboardButton("Ø´ÛŒÙØª Ø´Ø¨", callback_data="shift_night")],
        ]
    markup = InlineKeyboardMarkup(buttons)

    txt = "ğŸ”¸ Ù„Ø·ÙØ§Ù‹ *Ø´ÛŒÙØª* Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
    await send_msg(update_or_query, txt, markup)


# ============================================================
#       Ù…ØªØ±Ø§Ú˜ Ø´Ø±ÙˆØ¹
# ============================================================

async def ask_start_depth(update_or_query, user_id):
    user_states[user_id] = STEP_START_DEPTH
    shift = user_data[user_id]["current_shift"]
    await send_msg(
        update_or_query,
        f"ğŸ”¹ *Ù…ØªØ±Ø§Ú˜ Ø´Ø±ÙˆØ¹* Ø´ÛŒÙØª {fa_shift(shift)} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
        None
    )


async def handle_start_depth(update, user_id, text):
    try:
        val = float(text.replace(",", "."))
    except:
        await update.message.reply_text("â›” Ù…Ù‚Ø¯Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    shift = user_data[user_id]["current_shift"]
    user_data[user_id]["shifts"][shift]["start"] = val

    user_states[user_id] = STEP_END_DEPTH
    await update.message.reply_text(
        f"ğŸ”¹ *Ù…ØªØ±Ø§Ú˜ Ù¾Ø§ÛŒØ§Ù†* Ø´ÛŒÙØª {fa_shift(shift)} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
        parse_mode="Markdown"
    )


# ============================================================
#       Ù…ØªØ±Ø§Ú˜ Ù¾Ø§ÛŒØ§Ù† + Ø±ÙØªÙ† Ø¨Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ² Ø¨Ø§ Ø¯Ú©Ù…Ù‡
# ============================================================

async def handle_end_depth(update, user_id, text):
    try:
        val = float(text.replace(",", "."))
    except:
        await update.message.reply_text("â›” Ù…Ù‚Ø¯Ø§Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±.")
        return

    shift = user_data[user_id]["current_shift"]
    start_val = user_data[user_id]["shifts"][shift].get("start", 0)
    user_data[user_id]["shifts"][shift]["end"] = val

    length = val - start_val
    user_data[user_id]["shifts"][shift]["length"] = length

    user_states[user_id] = STEP_SIZE

    # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ² Ø­ÙØ§Ø±ÛŒ
    buttons = [
        [InlineKeyboardButton("BQ", callback_data="size_BQ")],
        [InlineKeyboardButton("NQ", callback_data="size_NQ")],
        [InlineKeyboardButton("HQ", callback_data="size_HQ")],
        [InlineKeyboardButton("PQ", callback_data="size_PQ")],
    ]
    markup = InlineKeyboardMarkup(buttons)

    await update.message.reply_text(
        f"ğŸ”¹ Ù…ØªØ±Ø§Ú˜ Ø§ÛŒÙ† Ø´ÛŒÙØª = {length:.2f} Ù…ØªØ±\n\n"
        "Ù„Ø·ÙØ§Ù‹ *Ø³Ø§ÛŒØ² Ø­ÙØ§Ø±ÛŒ* Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=markup,
        parse_mode="Markdown"
    )


# ============================================================
#       Ø³Ø§ÛŒØ² Ø­ÙØ§Ø±ÛŒ
# ============================================================

async def set_size(query, user_id, size):
    shift = user_data[user_id]["current_shift"]
    user_data[user_id]["shifts"][shift]["size"] = size

    # Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ
    user_states[user_id] = STEP_MUD

    mud_buttons = [
        [InlineKeyboardButton("Ø³ÙˆÙ¾Ø±Ù…ÛŒÚ©Ø³", callback_data="mud_super")],
        [InlineKeyboardButton("CMC", callback_data="mud_cmc")],
        [InlineKeyboardButton("Ø®Ø§Ú© Ø§Ø±Ù‡", callback_data="mud_sawdust")],
        [InlineKeyboardButton("Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„", callback_data="mud_diesel")],
        [InlineKeyboardButton("âœ… Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨", callback_data="mud_done")],
    ]
    markup = InlineKeyboardMarkup(mud_buttons)

    await query.edit_message_text(
        "ğŸ”¹ Ù†ÙˆØ¹ Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†Ù†Ø¯ Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯).\n"
        "Ø¨Ø±Ø§ÛŒ *Ø­Ø°Ù* ÛŒÚ© Ù…ÙˆØ±Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø²Ù†ÛŒØ¯.\n"
        "Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†ØŒ Ø¯Ú©Ù…Ù‡ Â«âœ… Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.",
        reply_markup=markup,
        parse_mode="Markdown"
    )


async def toggle_mud(query, user_id, mud_key):
    shift = user_data[user_id]["current_shift"]
    mud_list = user_data[user_id]["shifts"][shift].setdefault("mud", [])

    translate = {
        "super": "Ø³ÙˆÙ¾Ø±Ù…ÛŒÚ©Ø³",
        "cmc": "CMC",
        "sawdust": "Ø®Ø§Ú© Ø§Ø±Ù‡",
        "diesel": "Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„",
    }

    mud_name = translate[mud_key]

    if mud_name in mud_list:
        mud_list.remove(mud_name)
    else:
        mud_list.append(mud_name)

    await query.edit_message_text(
        f"ğŸ”¹ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ù„ÛŒ: { ' + '.join(mud_list) if mud_list else 'Ù‡ÛŒÚ†'}\n"
        "Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒÚ© Ù…ÙˆØ±Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø²Ù†.\n"
        "Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†ØŒ Ø¯Ú©Ù…Ù‡ Â«âœ… Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨Â» Ø±Ø§ Ø¨Ø²Ù†.",
        reply_markup=query.message.reply_markup,
        parse_mode="Markdown"
    )


# ============================================================
#       Ø¢Ø¨ Ù…ØµØ±ÙÛŒ
# ============================================================

async def ask_water(query, user_id):
    user_states[user_id] = STEP_WATER
    shift = user_data[user_id]["current_shift"]

    await query.edit_message_text(
        f"ğŸ”¹ *Ù…Ù‚Ø¯Ø§Ø± Ø¢Ø¨ Ù…ØµØ±ÙÛŒ* Ø´ÛŒÙØª {fa_shift(shift)} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù„ÛŒØªØ±):",
        parse_mode="Markdown"
    )


async def handle_water(update, user_id, text):
    try:
        val = float(text.replace(",", "."))
    except:
        await update.message.reply_text("â›” Ù…Ù‚Ø¯Ø§Ø± Ø¢Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.")
        return

    shift = user_data[user_id]["current_shift"]
    user_data[user_id]["shifts"][shift]["water"] = val

    user_states[user_id] = STEP_DIESEL
    await update.message.reply_text(
        f"ğŸ”¹ *Ù…Ù‚Ø¯Ø§Ø± Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„* Ø´ÛŒÙØª {fa_shift(shift)} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù„ÛŒØªØ±):",
        parse_mode="Markdown"
    )


# ============================================================
#       Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„
# ============================================================

async def handle_diesel(update, user_id, text):
    try:
        val = float(text.replace(",", "."))
    except:
        await update.message.reply_text("â›” Ù…Ù‚Ø¯Ø§Ø± Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.")
        return

    shift = user_data[user_id]["current_shift"]
    user_data[user_id]["shifts"][shift]["diesel"] = val

    # Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø´ÛŒÙØª â†’ Ù¾Ø±Ø³ÛŒØ¯Ù† Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø´ÛŒÙØª Ø¯ÙˆÙ…
    user_states[user_id] = STEP_ASK_NEXT_SHIFT

    buttons = [
        [InlineKeyboardButton("Ø´ÛŒÙØª Ø¨Ø¹Ø¯ÛŒ (Ø´Ø¨)", callback_data="need_night")],
        [InlineKeyboardButton("Ø®ÛŒØ±ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡", callback_data="no_more_shift")],
    ]
    markup = InlineKeyboardMarkup(buttons)

    await update.message.reply_text(
        "ğŸ”¸ Ø¢ÛŒØ§ Ø´ÛŒÙØª Ø¯ÛŒÚ¯Ø±ÛŒ Ù‡Ù… Ø¨Ø§ÛŒØ¯ Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ",
        reply_markup=markup
    )


# ============================================================
#   Ø§ØªÙ…Ø§Ù… Ø´ÛŒÙØªâ€ŒÙ‡Ø§
# ============================================================

async def finish_shifts(query, user_id):
    user_states[user_id] = STEP_SHIFTS_DONE

    d = user_data[user_id]["shifts"]

    total_len = (d["day"].get("length", 0) or 0) + (d["night"].get("length", 0) or 0)
    total_water = (d["day"].get("water", 0) or 0) + (d["night"].get("water", 0) or 0)
    total_diesel = (d["day"].get("diesel", 0) or 0) + (d["night"].get("diesel", 0) or 0)

    msg = (
        "ğŸ”° **Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ø´ÛŒÙØªâ€ŒÙ‡Ø§:**\n"
        f"â€¢ Ù…Ø¬Ù…ÙˆØ¹ Ù…ØªØ±Ø§Ú˜: {total_len:.2f} Ù…ØªØ±\n"
        f"â€¢ Ù…Ø¬Ù…ÙˆØ¹ Ø¢Ø¨ Ù…ØµØ±ÙÛŒ: {total_water:.2f} Ù„ÛŒØªØ±\n"
        f"â€¢ Ù…Ø¬Ù…ÙˆØ¹ Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„: {total_diesel:.2f} Ù„ÛŒØªØ±\n\n"
        "ğŸ”œ Ù…Ø±Ø­Ù„Ù‡Ù” Ø¨Ø¹Ø¯: Ù…Ø³Ø¦ÙˆÙ„ Ø´ÛŒÙØª Ùˆ Ù¾Ø±Ø³Ù†Ù„ Ú©Ù…Ú©ÛŒ + ØªÙˆØ¶ÛŒØ­Ø§Øª + PDF"
    )

    await query.edit_message_text(msg, parse_mode="Markdown")


# ============================================================
#   ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# ============================================================

def fa_shift(key):
    return "Ø±ÙˆØ²" if key == "day" else "Ø´Ø¨"


async def send_msg(update_or_query, text, markup=None):
    try:
        await update_or_query.message.reply_text(text, reply_markup=markup)
    except:
        await update_or_query.edit_message_text(text, reply_markup=markup)


---

Ø§Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ø§Ø² Commit:

Railway Ø§Ú¯Ø± Ø®ÙˆØ¯Ø´ redeploy Ù†Ú©Ø±Ø¯ØŒ ÛŒÙ‡ Restart Ø¨Ø²Ù†

ØªÙˆ ØªÙ„Ú¯Ø±Ø§Ù…ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ /start Ø±Ùˆ Ø¨Ø²Ù† Ùˆ Ø§ÛŒÙ† Ù…Ø³ÛŒØ± Ø±Ùˆ ØªØ³Øª Ú©Ù†:

ØªØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÛŒÙØª

Ù…ØªØ±Ø§Ú˜ Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†

Ø¯ÛŒØ¯Ù† Ù…ØªØ±Ø§Ú˜ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡ + Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ²

Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ²

Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ù„ Ø­ÙØ§Ø±ÛŒ (Ø§Ø¶Ø§ÙÙ‡/Ø­Ø°Ù Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¯ÙˆØ¨Ø§Ø±Ù‡)

Ø²Ø¯Ù† Â«âœ… Ø§ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨Â» â†’ Ø±ÙØªÙ† Ø¨Ù‡ Ø¢Ø¨

Ø¨Ø¹Ø¯ Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„

Ø¨Ø¹Ø¯ Ø³Ø¤Ø§Ù„ Ø´ÛŒÙØª Ø¯ÙˆÙ…



Ø§ÛŒÙ†â€ŒØ·ÙˆØ±ÛŒ Ù‡Ù… Ø¨Ø§Ú¯ Ù‚Ø¨Ù„ÛŒ Ù¾ÙˆØ´Ø´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡ØŒ Ù‡Ù… UX Ù…ÛŒâ€ŒØ´ÛŒÙ†Ù‡ Ø³Ø± Ø¬Ø§Ø´.

ÙˆÙ‚ØªÛŒ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø±Ùˆ ØªØ³Øª Ú©Ø±Ø¯ÛŒØŒ Ø¨Ø±ÛŒÙ… Ø³Ø±Ø§Øº Ø¨Ø®Ø´ Ø¨Ø¹Ø¯ÛŒ:
Ù…Ø³Ø¦ÙˆÙ„ Ø´ÛŒÙØªØŒ Ù¾Ø±Ø³Ù†Ù„ Ú©Ù…Ú©ÛŒØŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ù…Ø¬Ø§Ø² ØªÙˆØ¶ÛŒØ­Ø§ØªØŒ Ùˆ Ø¨Ø¹Ø¯Ø´ Ø­Ù…Ù„Ù‡ Ø¨Ù‡ PDF Ù†Ù‡Ø§ÛŒÛŒ.

